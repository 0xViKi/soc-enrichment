<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>
    Email Investigation Report - {{ header.subject or "Unknown Subject" }}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inline CSS: layout, typography, theming -->
  <style>
    /* ---------------------------------------------------------
       GLOBAL LAYOUT + TYPOGRAPHY
    --------------------------------------------------------- */
    :root {
      --bg-main: #050816;
      --bg-card: rgba(14, 20, 40, 0.97);
      --bg-soft: rgba(19, 29, 58, 0.9);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-soft: rgba(255, 255, 255, 0.05);
      --text-main: #e4e9ff;
      --text-muted: #9ca7c6;
      --accent-cyan: #37e0ff;
      --accent-magenta: #ff4fbf;
      --accent-amber: #ffc857;
      --accent-green: #6dffba;
      --danger: #ff6363;
      --danger-soft: #3b151f;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 40px 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        sans-serif;
      background: radial-gradient(circle at top, #10192c 0, #050816 55%);
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.55;
    }

    .report-container {
      max-width: 1500px; /* wider layout */
      margin: 0 auto;
      padding: 0 24px 32px;
    }

    a {
      color: var(--accent-cyan);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* ---------------------------------------------------------
       HEADER BANNER
    --------------------------------------------------------- */
    .report-header {
      background: linear-gradient(
        135deg,
        rgba(33, 150, 243, 0.18),
        rgba(156, 39, 176, 0.18)
      );
      border-radius: var(--radius-lg);
      border: 1px solid rgba(120, 179, 255, 0.25);
      padding: 18px 22px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr) auto;
      column-gap: 18px;
      row-gap: 8px;
      align-items: center;
    }

    .header-left {
      min-width: 0;
    }

    .header-pill-top {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent-cyan);
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .header-top-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.4px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;         /* max 2 lines before ellipsis */
      -webkit-box-orient: vertical;
    }

    .header-sub {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .header-meta {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header-meta-item {
      display: flex;
      flex-direction: column;
    }

    .header-meta-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 2px;
      opacity: 0.85;
    }

    .header-meta-value {
      font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      word-break: break-all;
    }

    .header-risk-block {
      text-align: right;
    }

    .risk-pill-large {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      background: var(--danger-soft);
      color: #ffd4d4;
      border: 1px solid rgba(255, 99, 99, 0.4);
      margin-bottom: 4px;
      white-space: nowrap;
    }

    .risk-pill-large.low {
      background: #0f2a1c;
      color: var(--accent-green);
      border-color: rgba(109, 255, 186, 0.4);
    }

    .risk-pill-large.medium {
      background: #372712;
      color: var(--accent-amber);
      border-color: rgba(255, 200, 87, 0.5);
    }

    .header-risk-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ---------------------------------------------------------
       GENERIC SECTION CARD
    --------------------------------------------------------- */
    .section-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 22px 26px;
      box-shadow: var(--shadow-soft);
      margin-top: 26px;
    }

    .section-title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #9eb6ff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .section-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(159, 168, 218, 0.4);
      color: #b9c7ff;
      background: rgba(49, 65, 132, 0.25);
    }

    /* ---------------------------------------------------------
       TABLES & BADGES
    --------------------------------------------------------- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    thead tr th {
      background: rgba(35, 44, 80, 0.95);
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      color: #c3d0ff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    tbody tr td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      vertical-align: top;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .mono {
      font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      margin-right: 8px;
      white-space: nowrap;
    }

    .badge.low {
      background: #10291c;
      color: var(--accent-green);
      border: 1px solid rgba(109, 255, 186, 0.45);
    }

    .badge.medium {
      background: #2d2614;
      color: var(--accent-amber);
      border: 1px solid rgba(255, 200, 87, 0.5);
    }

    .badge.high,
    .badge.critical {
      background: #35141c;
      color: #ff9aa9;
      border: 1px solid rgba(255, 99, 132, 0.7);
    }

    .badge.label {
      background: rgba(36, 56, 119, 0.8);
      color: #b5c3ff;
      border: 1px solid rgba(111, 147, 255, 0.6);
    }

    .pill-inline-muted {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(22, 31, 60, 0.9);
      color: var(--text-muted);
      font-size: 11px;
      margin-left: 6px;
    }

    /* ---------------------------------------------------------
       RISK BREAKDOWN BAR
    --------------------------------------------------------- */
    .risk-score-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 10px;
    }

    .risk-score-value {
      font-size: 28px;
      font-weight: 700;
    }

    .risk-bar-outer {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: rgba(17, 24, 39, 0.85);
      overflow: hidden;
    }

    .risk-bar-inner {
      height: 100%;
      background: linear-gradient(
        90deg,
        #1ec4ff,
        #ffc857,
        #ff6b6b,
        #ff4fbf
      );
      transition: width 0.4s ease-out;
      width: {{ risk.score if risk and risk.score is not none else 0 }}%;
    }

    /* ---------------------------------------------------------
       EMAIL OVERVIEW GRID
    --------------------------------------------------------- */
    .overview-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px 40px;
      margin-top: 8px;
    }

    .overview-kv {
      font-size: 14px;
    }

    .overview-kv dt {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .overview-kv dd {
      margin: 0 0 10px;
      font-weight: 500;
      word-break: break-all;
    }

    /* ---------------------------------------------------------
       BODY CONTENT PREVIEW
    --------------------------------------------------------- */
    .preview-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--text-muted);
      gap: 10px;
      flex-wrap: wrap;
    }

    .preview-toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 255, 0.6);
      padding: 5px 12px;
      font-size: 12px;
      color: #e5e7ff;
      background: rgba(15, 23, 42, 0.9);
      text-decoration: none;
      cursor: pointer;
    }

    .btn-ghost:hover {
      background: rgba(37, 99, 235, 0.25);
      text-decoration: none;
    }

    .preview-box {
      background: radial-gradient(circle at top left, #141b33, #050815);
      border: 1px solid rgba(255, 255, 255, 0.07);
      padding: 18px;
      border-radius: 9px;
      /* IMPORTANT: don't preserve whitespace on the container */
      white-space: normal;
      font-family: "JetBrains Mono", monospace;
      font-size: 14px;
      max-height: 460px;
      overflow: auto;
      line-height: 1.5;
    }

    /* Preserve whitespace only for the actual text content inside */
    #preview-plain,
    #preview-html {
      white-space: pre-wrap;
    }

    .preview-box > div {
      padding: 18px;
    }

    .preview-box iframe {
      width: 100%;
      height: 420px;
      border: none;
      display: block;
      margin: 0;
      padding: 0;
      background: #ffffff;
    }

    .preview-tabs {
      display: inline-flex;
      align-items: center;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 2px;
      border: 1px solid rgba(148, 163, 255, 0.45);
      gap: 2px;
    }

    .preview-tab-btn {
      border: none;
      background: transparent;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      font-family: inherit;
    }

    .preview-tab-btn.active {
      background: linear-gradient(135deg, #37e0ff, #ff4fbf);
      color: #020617;
      font-weight: 600;
    }

    .preview-tab-btn:focus-visible {
      outline: 2px solid var(--accent-cyan);
      outline-offset: 1px;
    }

    /* ---------------------------------------------------------
       ATTACHMENTS & HASH ENRICHMENT
    --------------------------------------------------------- */
    .hashes-list {
      font-size: 13px;
      line-height: 1.4;
    }

    .hashes-list div {
      margin-bottom: 2px;
    }

    .enrichment-cell {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .enrichment-meta {
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .enrichment-meta span {
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 2px;
    }

    /* ---------------------------------------------------------
       INFRASTRUCTURE IOCs
    --------------------------------------------------------- */
    .two-col-stack {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 22px;
    }

    .ioc-notes {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ---------------------------------------------------------
       ENGINE VERDICTS
    --------------------------------------------------------- */
    .engine-block {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
    }

    .engine-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .engine-details-table {
      margin-top: 10px;
      font-size: 13px;
    }

    .engine-details-table thead th {
      font-size: 12px;
    }

    /* ---------------------------------------------------------
       TIMELINE
    --------------------------------------------------------- */
    .timeline-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border-left: 1px solid rgba(129, 140, 248, 0.4);
    }

    .timeline-item {
      position: relative;
      padding: 10px 0 10px 20px;
    }

    .timeline-dot {
      position: absolute;
      left: -6px;
      top: 17px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.35);
    }

    .timeline-title {
      font-size: 14px;
      font-weight: 500;
    }

    .timeline-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .timeline-details {
      font-size: 13px;
      margin-top: 4px;
      color: #cbd5ff;
    }

    /* ---------------------------------------------------------
       FOOTER
    --------------------------------------------------------- */
    .report-footer {
      margin-top: 22px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    @media (max-width: 960px) {
      .report-header {
        grid-template-columns: minmax(0, 1fr);
        row-gap: 10px;
      }
      .header-risk-block {
        text-align: left;
      }
      .overview-grid,
      .two-col-stack {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="report-container">
    <!-- =====================================================
         TOP HEADER
    ====================================================== -->
    <header class="report-header">
      <div class="header-left">
        <div class="header-pill-top">
          PHISHING / EMAIL INVESTIGATION REPORT
        </div>
        <div class="header-top-title">
          {{ header.subject or "Unknown subject" }}
        </div>
        <div class="header-sub">
          From: <span class="mono">{{ header.from_addr or "N/A" }}</span>
        </div>
      </div>

      <div class="header-meta">
        <div class="header-meta-item">
          <div class="header-meta-label">Case ID</div>
          <div class="header-meta-value">
            {{ meta.case_id or "N/A" }}
          </div>
        </div>
        <div class="header-meta-item">
          <div class="header-meta-label">Received</div>
          <div class="header-meta-value">
            {{ header.date or "N/A" }}
          </div>
        </div>
      </div>

      <div class="header-risk-block">
        {% set level = risk.level if risk and risk.level else "low" %}
        <div class="risk-pill-large {{ level }}">
          {{ risk.score or 0 }}/100&nbsp;&nbsp;
          {{ level | upper }} RISK
        </div>
        <div class="header-risk-sub">
          Report generated {{ meta.generated_at if meta else "" }}
        </div>
      </div>
    </header>

    <!-- =====================================================
         SECTION: RISK BREAKDOWN
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Risk Breakdown
          <span class="section-tag">Malicious indicators across email</span>
        </div>
      </div>

      <div class="risk-score-row">
        <div>
          <div style="font-size:13px;color:var(--text-muted);margin-bottom:2px;">
            Overall score
          </div>
          <div class="risk-score-value">
            {{ risk.score or 0 }}
            <span style="font-size:14px;color:var(--text-muted);font-weight:500;">
              / 100
            </span>
          </div>
        </div>

        <div class="risk-bar-outer">
          <div class="risk-bar-inner"></div>
        </div>

        <div>
          {% if risk.level == "high" or risk.level == "critical" %}
          <span class="badge high">High Risk</span>
          {% elif risk.level == "medium" %}
          <span class="badge medium">Medium Risk</span>
          {% else %}
          <span class="badge low">Low Risk</span>
          {% endif %}
        </div>
      </div>

      <div style="margin-top:16px;">
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:6px;">
          Key phishing indicators detected:
        </div>
        {% if risk.reasons %}
        <ul style="margin:0;padding-left:18px;font-size:14px;">
          {% for reason in risk.reasons %}
          <li>{{ reason }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <div style="font-size:14px;color:var(--text-muted);">
          No strong phishing indicators were detected by the heuristic engine.
        </div>
        {% endif %}
      </div>
    </section>

    <!-- =====================================================
         SECTION: EMAIL OVERVIEW
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Email Overview
          <span class="section-tag">Core metadata from .eml</span>
        </div>
      </div>

      <div class="overview-grid">
        <dl class="overview-kv">
          <dt>FROM</dt>
          <dd class="mono">{{ header.from_addr or "N/A" }}</dd>

          <dt>REPLY-TO</dt>
          <dd class="mono">{{ header.reply_to or "N/A" }}</dd>

          <dt>MESSAGE ID</dt>
          <dd class="mono">{{ header.message_id or "N/A" }}</dd>

          <dt>RETURN PATH</dt>
          <dd class="mono">{{ header.return_path or "N/A" }}</dd>
        </dl>

        <dl class="overview-kv">
          <dt>TO</dt>
          <dd class="mono">{{ header.to or "N/A" }}</dd>

          <dt>DATE</dt>
          <dd class="mono">{{ header.date or "N/A" }}</dd>

          <dt>RECEIVED DOMAINS</dt>
          <dd class="mono">
            {% if header.received_domains %}
              {{ header.received_domains | join(" → ") }}
            {% else %}
              N/A
            {% endif %}
          </dd>

          <dt>RECEIVED IPs</dt>
          <dd class="mono">
            {% if header.received_ips %}
              {{ header.received_ips | join(", ") }}
            {% else %}
              N/A
            {% endif %}
          </dd>
        </dl>
      </div>
    </section>

    <!-- ===================================================== 
      SECTION: BODY CONTENT
    ====================================================== -->
    {% set ns = namespace(plain=None, html=None) %}
    {% if bodies %}
      {% for b in bodies %}
        {% if ns.plain is none and (b.content_type or "").startswith("text/plain") %}
          {% set ns.plain = b %}
        {% elif ns.html is none and (b.content_type or "").startswith("text/html") %}
          {% set ns.html = b %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Body Content
          <span class="section-tag">Preview of extracted text / HTML</span>
        </div>
      </div>

      <div class="preview-toolbar">
        <div>
          Showing first available body part
          {% if bodies|length > 1 %}
          <span class="pill-inline-muted">
            {{ bodies|length }} parts extracted
          </span>
          {% endif %}
        </div>
        <div>
          {% if ns.plain or ns.html %}
          <div class="preview-tabs">
            {% if ns.plain %}
              <button
                class="preview-tab-btn active"
                type="button"
                data-target="plain"
              >
                Text (text/plain)
              </button>
            {% endif %}
            {% if ns.html %}
              <button
                class="preview-tab-btn {% if not ns.plain %}active{% endif %}"
                type="button"
                data-target="rendered"
              >
                HTML (rendered)
              </button>
              <button
                class="preview-tab-btn"
                type="button"
                data-target="html"
              >
                HTML (raw)
              </button>
            {% endif %}
          </div>
          {% else %}
          Content types:
          <span class="mono">
            {% for b in bodies %}
              {{ b.content_type or "unknown" }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          </span>
          {% endif %}
        </div>
      </div>

      {% if ns.plain or ns.html %}
      <div class="preview-box" id="preview-container">
        {% if ns.plain %}
        <div id="preview-plain">
          {% if ns.plain.content %}
            {{ ns.plain.content }}
          {% else %}
            No text/plain body content available.
          {% endif %}
        </div>
        {% endif %}

        {% if ns.html %}
        <!-- Rendered HTML (sandboxed iframe) -->
        <div
          id="preview-html-rendered"
          {% if ns.plain %}style="display:none;"{% endif %}
        >
          {% if ns.html.content %}
            <iframe
              sandbox=""
              srcdoc="{{ ns.html.content | e }}"
            ></iframe>
          {% else %}
            No text/html body content available.
          {% endif %}
        </div>

        <!-- Raw HTML source (escaped) -->
        <div
          id="preview-html"
          style="display:none;"
        >
          {% if ns.html.content %}
            {{ ns.html.content | e }}
          {% else %}
            No text/html body content available.
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% else %}
        <div class="preview-box">
          No body content available in parsed result.
        </div>
      {% endif %}
    </section>

    <!-- =====================================================
         SECTION: ATTACHMENTS & HASH ENRICHMENT
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Attachments &amp; Hash Enrichment
          <span class="section-tag">File metadata and VirusTotal-style scoring</span>
        </div>
        <div class="section-subtitle">
          {% if attachments %}
            {{ attachments|length }} attachment{{ "s" if attachments|length != 1 else "" }} extracted
          {% else %}
            No attachments in this email
          {% endif %}
        </div>
      </div>

      {% if attachments %}
      <table>
        <thead>
          <tr>
            <th style="width:18%;">Filename</th>
            <th style="width:11%;">Size</th>
            <th style="width:15%;">MIME</th>
            <th style="width:25%;">Hashes</th>
            <th style="width:31%;">Enrichment</th>
          </tr>
        </thead>
        <tbody>
          {% for att, enriched in attachment_pairs %}
          <tr>
            <td class="mono">{{ att.filename or "N/A" }}</td>
            <td>
              {% if att.size_bytes is defined and att.size_bytes is not none %}
                {{ "%.1f"|format(att.size_bytes / 1024) }} KB
              {% elif att.size is defined and att.size is not none %}
                {{ "%.1f"|format(att.size / 1024) }} KB
              {% else %}
                N/A
              {% endif %}
            </td>
            <td class="mono">{{ att.content_type or "N/A" }}</td>
            <td>
              {% if att.hashes %}
              <div class="hashes-list mono">
                {% if att.hashes.sha256 %}<div>sha256: {{ att.hashes.sha256 }}</div>{% endif %}
                {% if att.hashes.sha1 %}<div>sha1: {{ att.hashes.sha1 }}</div>{% endif %}
                {% if att.hashes.md5 %}<div>md5: {{ att.hashes.md5 }}</div>{% endif %}
              </div>
              {% else %}
              <span class="ioc-notes">No hashes available</span>
              {% endif %}
            </td>
            <td>
              <div class="enrichment-cell">
                {% if enriched and enriched.enrichment and enriched.enrichment.vt %}
                  {% set vt = enriched.enrichment.vt %}
                  {% set vt_risk = enriched.enrichment.risk if enriched.enrichment.risk else None %}
                  {% if vt_risk %}
                    {% set sev = vt_risk.severity or "low" %}
                    <div>
                      <span class="badge {{ sev }}">{{ sev|upper }}</span>
                      <span style="font-size:13px;">
                        Score: {{ vt_risk.score }}/100
                      </span>
                    </div>
                  {% else %}
                    <div>
                      <span class="badge label">VirusTotal</span>
                    </div>
                  {% endif %}
                  <div class="enrichment-meta">
                    <span>Type: {{ vt.type_description or vt.type_tag or "N/A" }}</span>
                    {% if vt.last_analysis_stats %}
                      <span>
                        Detections:
                        {{ vt.last_analysis_stats.malicious or 0 }}/
                        {{
                          (vt.last_analysis_stats.malicious or 0)
                          + (vt.last_analysis_stats.suspicious or 0)
                          + (vt.last_analysis_stats.undetected or 0)
                          + (vt.last_analysis_stats.harmless or 0)
                        }}
                      </span>
                    {% endif %}
                    {% if vt.names and vt.names|length > 0 %}
                      <span>
                        Sample name:
                        <span class="mono">{{ vt.names[0] }}</span>
                      </span>
                    {% endif %}
                  </div>
                {% else %}
                  <span class="ioc-notes">
                    No enrichment available for this attachment.
                  </span>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="ioc-notes">
        No attachments were extracted from the email.
      </div>
      {% endif %}
    </section>

    <!-- =====================================================
         SECTION: INFRASTRUCTURE IOCs (DOMAINS + IPs)
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Infrastructure IOCs
          <span class="section-tag">Domains &amp; IPs with OSINT enrichment</span>
        </div>
      </div>

      <div class="two-col-stack">
        <!-- Domains -->
        <div>
          <div style="font-size:14px;font-weight:500;margin-bottom:8px;">
            Domains
            {% if enrichment.domains %}
              <span class="pill-inline-muted">
                {{ enrichment.domains|length }} enriched
              </span>
            {% endif %}
          </div>
          {% if enrichment.domains %}
          <table>
            <thead>
              <tr>
                <th style="width:38%;">Domain</th>
                <th style="width:17%;">Risk</th>
                <th style="width:45%;">Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for d in enrichment.domains %}
              {% set data = d.enrichment %}
              {% set risk_info = data.risk if data and data.risk else None %}
              {% set sev = risk_info.severity if risk_info and risk_info.severity else "low" %}
              <tr>
                <td class="mono">{{ d.domain }}</td>
                <td>
                  {% if risk_info %}
                    <span class="badge {{ sev }}">
                      {{ sev|upper }}
                    </span>
                    <span style="font-size:13px;">
                      {{ risk_info.score }}/100
                    </span>
                  {% else %}
                    <span class="ioc-notes">No risk score</span>
                  {% endif %}
                </td>
                <td class="ioc-notes">
                  {% if data and data.whois %}
                    {% if data.whois.domain_age_days is not none %}
                      Age: {{ data.whois.domain_age_days }} days.
                    {% endif %}
                    {% if data.whois.registrar %}
                      &nbsp;Reg: {{ data.whois.registrar }}.
                    {% endif %}
                  {% endif %}
                  {% if data and data.urlscan and data.urlscan.malicious_count is not none %}
                    &nbsp;URLScan detections: {{ data.urlscan.malicious_count }}.
                  {% endif %}
                  {% if not (data and (data.whois or data.urlscan)) %}
                    No enrichment details.
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="ioc-notes">
            No domains were extracted or enriched.
          </div>
          {% endif %}
        </div>

        <!-- IPs -->
        <div>
          <div style="font-size:14px;font-weight:500;margin-bottom:8px;">
            IP addresses
            {% if enrichment.ips %}
              <span class="pill-inline-muted">
                {{ enrichment.ips|length }} enriched
              </span>
            {% endif %}
          </div>
          {% if enrichment.ips %}
          <table>
            <thead>
              <tr>
                <th style="width:30%;">IP</th>
                <th style="width:20%;">Risk</th>
                <th style="width:50%;">Geo / Reputation</th>
              </tr>
            </thead>
            <tbody>
              {% for ip in enrichment.ips %}
              {% set data = ip.enrichment %}
              {% set risk_info = data.risk if data and data.risk else None %}
              {% set sev = risk_info.severity if risk_info and risk_info.severity else "low" %}
              <tr>
                <td class="mono">{{ ip.ip }}</td>
                <td>
                  {% if risk_info %}
                    <span class="badge {{ sev }}">
                      {{ sev|upper }}
                    </span>
                    <span style="font-size:13px;">
                      {{ risk_info.score }}/100
                    </span>
                  {% else %}
                    <span class="ioc-notes">No risk score</span>
                  {% endif %}
                </td>
                <td class="ioc-notes">
                  {% if data and data.geo %}
                    {{ data.geo.country_name or "" }}
                    {% if data.geo.city %} - {{ data.geo.city }}{% endif %}.
                  {% endif %}
                  {% if data and data.abuseipdb %}
                    &nbsp;AbuseIPDB:
                    {{ data.abuseipdb.abuseConfidenceScore or 0 }} score,
                    {{ data.abuseipdb.totalReports or 0 }} reports.
                  {% endif %}
                  {% if not (data and (data.geo or data.abuseipdb)) %}
                    No geo / reputation data.
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="ioc-notes">
            No IP addresses were extracted or enriched.
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- =====================================================
         SECTION: ENGINE VERDICTS (SpamAssassin etc.)
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Engine Verdicts
          <span class="section-tag">SpamAssassin / Oleid and other engines</span>
        </div>
      </div>

      {% if verdicts %}
        {% for v in verdicts %}
        <div class="engine-block">
          <div class="engine-header-row">
            <div>
              <strong>{{ v.name }}</strong>
              {% if v.malicious %}
                <span class="badge high">Malicious</span>
              {% else %}
                <span class="badge low">Benign</span>
              {% endif %}
            </div>
            <div style="font-size:13px;color:var(--text-muted);">
              Score:
              <span class="mono">{{ v.score if v.score is not none else "N/A" }}</span>
            </div>
          </div>

          {% if v.details %}
          <table class="engine-details-table">
            <thead>
              <tr>
                <th style="width:28%;">Rule</th>
                <th style="width:10%;">Score</th>
                <th style="width:52%;">Description</th>
                <th style="width:10%;">Ref</th>
              </tr>
            </thead>
            <tbody>
              {% for d in v.details %}
              <tr>
                <td class="mono">{{ d.key or "-" }}</td>
                <td class="mono">{{ d.score if d.score is not none else "-" }}</td>
                <td>{{ d.description or "-" }}</td>
                <td>
                  {% if d.referenceLink %}
                    <a href="{{ d.referenceLink }}" target="_blank">link</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="ioc-notes">
            No granular rule details provided by this engine.
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
      <div class="ioc-notes">
        No engine verdicts were returned by the analyzer.
      </div>
      {% endif %}
    </section>

    <!-- =====================================================
         SECTION: INVESTIGATION TIMELINE
    ====================================================== -->
    <section class="section-card">
      <div class="section-title-row">
        <div class="section-title">
          Investigation Timeline
          <span class="section-tag">High-level sequence of events</span>
        </div>
      </div>

      {% if timeline %}
      <ul class="timeline-list">
        {% for ev in timeline %}
        <li class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="timeline-title">
            {% if ev.type == "email_received" %}
              EMAIL RECEIVED
            {% elif ev.type == "attachments_extracted" %}
              ATTACHMENTS EXTRACTED
            {% elif ev.type == "ioc_enrichment_completed" %}
              IOC ENRICHMENT COMPLETED
            {% else %}
              {{ ev.type|upper }}
            {% endif %}
          </div>
          <div class="timeline-meta">
            {% if ev.ts %}
              {{ ev.ts }}
            {% else %}
              Time not available
            {% endif %}
          </div>
          <div class="timeline-details">
            {% if ev.type == "email_received" and ev.details.subject %}
              Email received: “{{ ev.details.subject }}”
            {% elif ev.type == "attachments_extracted" %}
              {{ ev.details.count }} attachment{{ "s" if ev.details.count != 1 else "" }} extracted.
            {% elif ev.type == "ioc_enrichment_completed" %}
              Enriched
              {{ ev.details.domains }} domain{{ "s" if ev.details.domains != 1 else "" }}
              and
              {{ ev.details.ips }} IP{{ "s" if ev.details.ips != 1 else "" }}.
            {% else %}
              {{ ev.details }}
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="ioc-notes">
        Timeline information is not available for this message.
      </div>
      {% endif %}
    </section>

    <!-- =====================================================
         FOOTER
    ====================================================== -->
    <div class="report-footer">
      Report generated at {{ meta.generated_at if meta else "" }} (UTC).
      All timestamps in this report reflect the original email headers.
    </div>
  </div>

   <!-- =======================================================
       SMALL SCRIPT: BODY PREVIEW TAB SWITCHING
  ======================================================== -->
  <script>
    (function () {
      var tabButtons = document.querySelectorAll(".preview-tab-btn");
      if (!tabButtons.length) return;

      var views = {
        plain: document.getElementById("preview-plain"),
        rendered: document.getElementById("preview-html-rendered"),
        html: document.getElementById("preview-html")
      };

      function attachIframeMarginFix() {
        var iframeWrapper = views.rendered;
        if (!iframeWrapper) return;
        var iframe = iframeWrapper.querySelector("iframe");
        if (!iframe) return;

        iframe.addEventListener("load", function () {
          try {
            var doc = iframe.contentDocument || iframe.contentWindow.document;
            if (!doc || !doc.body) return;
            doc.body.style.margin = "0";
            doc.body.style.padding = "0";
          } catch (e) {
            // ignore cross-origin issues (shouldn't happen with srcdoc)
          }
        });
      }

      attachIframeMarginFix();

      tabButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var target = btn.getAttribute("data-target");

          tabButtons.forEach(function (b) {
            b.classList.toggle("active", b === btn);
          });

          Object.keys(views).forEach(function (key) {
            if (!views[key]) return;
            views[key].style.display = key === target ? "block" : "none";
          });
        });
      });
    })();
  </script>
</body>
</html>
